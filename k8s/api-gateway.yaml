apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
spec:
  replicas: 1
  selector:
    matchLabels:
      app: api-gateway
  template:
    metadata:
      labels:
        app: api-gateway
    spec:
      containers:
        - name: api-gateway
          image: us-central1-docker.pkg.dev/hello-481616/book-repo/api-gateway:latest
          ports:
            - containerPort: 8080
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
          env:
                  - name: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
                    value: "http://eureka-server:8761/eureka/"
                  # INCREASE TIMEOUTS
                  - name: SPRING_CLOUD_GATEWAY_HTTPCLIENT_CONNECT_TIMEOUT
                    value: "50000"  # 50 seconds
                  - name: SPRING_CLOUD_GATEWAY_HTTPCLIENT_RESPONSE_TIMEOUT
                    value: "50s"    # 50 seconds
                  # If using Ribbon (older Spring Cloud)
                  - name: RIBBON_READTIMEOUT
                    value: "50000"
                  - name: RIBBON_CONNECTTIMEOUT
                    value: "50000"
---
apiVersion: v1
kind: Service
metadata:
  name: api-gateway
spec:
  type: LoadBalancer
  selector:
    app: api-gateway
  ports:
    - port: 80
      targetPort: 8080